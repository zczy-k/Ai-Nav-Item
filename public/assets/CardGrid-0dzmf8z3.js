var ee=Object.defineProperty,ne=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var z=(o,i,t)=>i in o?ee(o,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[i]=t,I=(o,i)=>{for(var t in i||(i={}))oe.call(i,t)&&z(o,t,i[t]);if(O)for(var t of O(i))ie.call(i,t)&&z(o,t,i[t]);return o},L=(o,i)=>ne(o,te(i));var D=(o,i,t)=>new Promise((r,g)=>{var x=m=>{try{s(t.next(m))}catch(u){g(u)}},a=m=>{try{s(t.throw(m))}catch(u){g(u)}},s=m=>m.done?r(m.value):Promise.resolve(m.value).then(x,a);s((t=t.apply(o,i)).next())});import{r as y,E as ce,_ as se,a as P,o as le,b as w,d as k,f as re,F as ae,g as ue,w as N,i as _,e as d,h as $,t as j,n as de,T as fe}from"./index-CAeISmA9.js";const me=4,A=[1e3,2e3,4e3],c=ce({queue:[],running:0,cache:new Map,failedUrls:new Set,observers:new Map});function ge(o,i=0){const t=[r=>`/api/icon?url=${encodeURIComponent(r)}`,r=>`https://api.xinac.net/icon/?url=${r}&sz=128`,r=>`https://www.google.com/s2/favicons?domain=${new URL(r).hostname}&sz=128`,r=>`https://icon.horse/icon/${new URL(r).hostname}`,r=>`https://favicon.im/${new URL(r).hostname}?larger=true`];try{return t[i%t.length](o)}catch(r){return t[0](o)}}function S(){for(;c.running<me&&c.queue.length>0;){const o=c.queue.shift();c.running++,pe(o).finally(()=>{c.running--,S()})}}function pe(o){return D(this,null,function*(){const{url:i,element:t,cardId:r,resolve:g,reject:x,retryCount:a=0,cdnIndex:s=0}=o;if(c.cache.has(i)){const u=c.cache.get(i);t&&(t.src=u),g==null||g(u);return}const m=ge(i,s);return new Promise(u=>{const p=new Image;p.crossOrigin="anonymous";const v=setTimeout(()=>{p.src="",b()},8e3);p.onload=()=>{clearTimeout(v),c.cache.set(i,m),t&&(t.src=m),g==null||g(m),u(m)},p.onerror=()=>{clearTimeout(v),b()};function b(){if(s<4)c.queue.unshift(L(I({},o),{cdnIndex:s+1,retryCount:0})),u(null);else if(a<A.length)setTimeout(()=>{c.queue.push(L(I({},o),{retryCount:a+1,cdnIndex:0})),S()},A[a]),u(null);else{c.failedUrls.add(i);const f="/icons/common/default-favicon.png";t&&(t.src=f),g==null||g(f),u(f)}}p.src=m})})}function ve(){const o=y(!1);function i(a,s=null,m=null){return new Promise((u,p)=>{if(!a){u("/icons/common/default-favicon.png");return}if(c.cache.has(a)){const v=c.cache.get(a);s&&(s.src=v),u(v);return}if(c.failedUrls.has(a)){const v="/icons/common/default-favicon.png";s&&(s.src=v),u(v);return}c.queue.push({url:a,element:s,cardId:m,resolve:u,reject:p}),S()})}function t(a,s,m=null){if(!a||!s)return;c.observers.has(a)&&c.observers.get(a).disconnect();const u=new IntersectionObserver(p=>{p.forEach(v=>{v.isIntersecting&&(i(s,a,m),u.disconnect(),c.observers.delete(a))})},{rootMargin:"200px",threshold:.01});return u.observe(a),c.observers.set(a,u),()=>{u.disconnect(),c.observers.delete(a)}}function r(a){a.forEach(s=>{!c.cache.has(s)&&!c.failedUrls.has(s)&&i(s)})}function g(){c.cache.clear(),c.failedUrls.clear()}function x(){return{cached:c.cache.size,failed:c.failedUrls.size,queued:c.queue.length,running:c.running}}return{queueIcon:i,setupLazyLoad:t,preloadIcons:r,clearCache:g,getCacheStats:x,isLoading:o}}const Ce=["data-card-id","onContextmenu","onClick"],he=["href","target","title","onClick"],xe=["data-url","onError"],ke={class:"link-text"},ye={key:0,class:"card-selected-badge"},E="/icons/common/default-favicon.png",be={__name:"CardGrid",props:{cards:Array,selectedCards:Array,categoryId:Number,subCategoryId:[Number,null],selectionMode:Boolean},emits:["contextEdit","contextDelete","toggleCardSelection","openMovePanel","requireAuth","cardClicked"],setup(o,{emit:i}){const t=o,r=i,g=y(null),{setupLazyLoad:x,queueIcon:a}=ve(),s=new Map;function m(n){try{return new URL(n).origin}catch(e){return null}}function u(n,e){if(!n||!e.url)return;if(s.has(e.id)&&s.get(e.id)(),e.logo_url){n.src=e.logo_url;return}const l=m(e.url);if(!l){n.src=E;return}const U=x(n,l,e.id);U&&s.set(e.id,U)}P(()=>{s.forEach(n=>n()),s.clear()});const p=y(!1),v=y(0),b=y(0),f=y(null);function B(n,e){f.value=e,v.value=n.clientX,b.value=n.clientY,p.value=!0}function h(){p.value=!1,f.value=null}function G(){f.value&&r("contextEdit",f.value),h()}function K(){f.value&&r("contextDelete",f.value),h()}function V(){f.value&&r("toggleCardSelection",f.value),h()}function Y(){f.value&&(M(f.value)||r("toggleCardSelection",f.value),r("openMovePanel")),h()}function X(){f.value&&(q(f.value.id),window.open(f.value.url,"_blank")),h()}function F(){if(f.value){const n=f.value.url;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).catch(()=>{R(n)}):R(n)}h()}function R(n){const e=document.createElement("textarea");e.value=n,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(l){console.error("Copy failed:",l)}document.body.removeChild(e)}function T(n){p.value&&h()}function Q(n,e){(n.ctrlKey||n.metaKey||t.selectionMode)&&(n.preventDefault(),n.stopPropagation(),r("toggleCardSelection",e))}function H(n,e){n.ctrlKey||n.metaKey||t.selectionMode?(n.preventDefault(),n.stopPropagation(),r("toggleCardSelection",e)):q(e.id)}function q(n){fetch(`/api/cards/${n}/click`,{method:"POST"}).catch(()=>{}),r("cardClicked",n)}le(()=>{document.addEventListener("click",T),document.addEventListener("scroll",h)}),P(()=>{document.removeEventListener("click",T),document.removeEventListener("scroll",h)});function J(n,e){if(n.target._retried){n.target.src=E;return}n.target._retried=!0;const l=m(e.url);l?a(l,n.target,e.id):n.target.src=E}function W(n){let e="";return n.desc&&(e+=n.desc+`
`),n.tags&&n.tags.length>0&&(e+="æ ‡ç­¾: "+n.tags.map(l=>l.name).join(", ")+`
`),e+=n.url,e}function Z(n){return n?n.length>20?n.slice(0,20)+"...":n:""}function M(n){var e;return((e=t.selectedCards)==null?void 0:e.some(l=>l.id===n.id))||!1}return(n,e)=>(k(),w("div",{ref_key:"cardGridRef",ref:g,class:_(["container card-grid",{"selection-mode":o.selectionMode}])},[(k(!0),w(ae,null,ue(o.cards,(l,U)=>(k(),w("div",{key:l.id,class:_(["link-item",{selected:M(l)}]),"data-card-id":l.id,onContextmenu:N(C=>B(C,l),["prevent"]),onClick:C=>Q(C,l)},[d("a",{href:o.selectionMode?"javascript:void(0)":l.url,target:o.selectionMode?"":"_blank",title:W(l),onClick:C=>H(C,l),class:"card-link"},[d("img",{class:"link-icon",ref_for:!0,ref:C=>C&&u(C,l),src:E,"data-url":l.url,alt:"",onError:C=>J(C,l)},null,40,xe),d("span",ke,j(Z(l.title)),1)],8,he),M(l)?(k(),w("div",ye,"âœ“")):$("",!0)],42,Ce))),128)),(k(),re(fe,{to:"body"},[p.value?(k(),w("div",{key:0,class:"context-menu",style:de({left:v.value+"px",top:b.value+"px"}),onClick:e[0]||(e[0]=N(()=>{},["stop"]))},[d("div",{class:"context-menu-item",onClick:G},[...e[1]||(e[1]=[d("span",{class:"context-menu-icon"},"âœï¸",-1),d("span",null,"ç¼–è¾‘",-1)])]),d("div",{class:"context-menu-item",onClick:K},[...e[2]||(e[2]=[d("span",{class:"context-menu-icon"},"ğŸ—‘ï¸",-1),d("span",null,"åˆ é™¤",-1)])]),e[7]||(e[7]=d("div",{class:"context-menu-divider"},null,-1)),d("div",{class:"context-menu-item",onClick:V},[e[3]||(e[3]=d("span",{class:"context-menu-icon"},"â˜‘ï¸",-1)),d("span",null,j(M(f.value)?"å–æ¶ˆé€‰ä¸­":"é€‰ä¸­"),1)]),d("div",{class:"context-menu-item",onClick:Y},[...e[4]||(e[4]=[d("span",{class:"context-menu-icon"},"ğŸ“",-1),d("span",null,"ç§»åŠ¨åˆ°...",-1)])]),e[8]||(e[8]=d("div",{class:"context-menu-divider"},null,-1)),d("div",{class:"context-menu-item",onClick:X},[...e[5]||(e[5]=[d("span",{class:"context-menu-icon"},"ğŸ”—",-1),d("span",null,"åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€",-1)])]),d("div",{class:"context-menu-item",onClick:F},[...e[6]||(e[6]=[d("span",{class:"context-menu-icon"},"ğŸ“‹",-1),d("span",null,"å¤åˆ¶é“¾æ¥",-1)])])],4)):$("",!0)]))],2))}},Ee=se(be,[["__scopeId","data-v-ac3b246d"]]);export{Ee as default};
